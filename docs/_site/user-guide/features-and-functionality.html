<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Telepresence - Features and Functionality</title>
  <meta name="description" content="Telepresence: a local development environment for a remote Kubernetes cluster">
  <meta name="keywords" content="Telepresence, Kubernetes, microservices">
  <meta name="author" content="Datawire.io">
  <meta name="generator" content="Doc42 0.1.0">

  <link rel="stylesheet" href="/css/kissui.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/sticky.min.css">
  
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');  ga('create', 'UA-57322503-8', 'auto');ga('send', 'pageview');</script>
  <link rel="canonical" href="http://telepresence.io/user-guide/features-and-functionality.html">
  <link rel="alternate" type="application/rss+xml" title="Telepresence" href="http://telepresence.io/feed.xml">
</head>


  <body>
      <div class="row">
    <header id="main_header">
        <nav class="basic border menu">
            <div class="fluid">
                <a class="header item" href="/">
                    Telepresence
                </a>

                <a class="item" href="/getting-started/install">
                    <i class="fa fa-download"></i> Download
                </a>
                <a class="item" href="https://github.com/datawire/telepresence/" target="_blank">
                    <i class="fa fa-github"></i> Github
                </a>
                <a class="item" href="https://gitter.im/datawire/telepresence" target="_blank">
                    <i class="fa fa-support"></i> Need help?
                </a>
            </div>
        </nav>
    </header>
</div>


      <div class="fluid">
          <div class="wrapper">
              <div class="row">
    <div class="two columns">
        <nav class="basic border fluid vertical menu" data-kui-sticky>
    

    <div class="items">
        <div class="icon item header">
            <i class="fa fa-question-circle"></i>about
        </div>
        

        
            
        
            
        
            
              
            
        
            
              
                
                    <a class="item" href="/about/why-telepresence.html">Why Telepresence?</a>
                
              
            
        
            
              
            
        
            
              
            
        
            
              
                
                    <a class="item" href="/about/how-it-works.html">How it works</a>
                
              
            
        
            
              
            
        
            
              
            
        
            
              
            
        
    </div>
    

    <div class="items">
        <div class="icon item header">
            <i class="fa fa-play"></i>getting started
        </div>
        

        
            
        
            
        
            
              
            
        
            
              
            
        
            
              
            
        
            
              
                
                    <a class="item" href="/getting-started/install.html">Installing Telepresence</a>
                
              
            
        
            
              
            
        
            
              
            
        
            
              
                
                    <a class="item" href="/getting-started/quickstart.html">Quickstart</a>
                
              
            
        
            
              
            
        
    </div>
    

    <div class="items">
        <div class="icon item header">
            <i class="fa fa-code"></i>user guide
        </div>
        

        
            
        
            
        
            
              
            
        
            
              
            
        
            
              
                
                    <a class="item" href="/user-guide/features-and-functionality.html">Features and Functionality</a>
                
              
            
        
            
              
            
        
            
              
            
        
            
              
                
                    <a class="item" href="/user-guide/limitations-and-workarounds.html">Limitations and Workarounds</a>
                
              
            
        
            
              
            
        
            
              
            
        
    </div>
    

    <div class="items">
        <div class="icon item header">
            <i class="fa fa-expand"></i>additional information
        </div>
        

        
            
        
            
        
            
              
                
                    <a class="item" href="/additional-information/changelog.html">Changelog</a>
                
              
            
        
            
              
            
        
            
              
            
        
            
              
            
        
            
              
            
        
            
              
            
        
            
              
            
        
            
              
                
                    <a class="item" href="/additional-information/developing.html">Development Info</a>
                
              
            
        
    </div>
    
</nav>

    </div>

    <div class="eight columns page-content">
        <header class="post-header">
            <h2 class="post-title">Features and Functionality</h3>
        </header>

        <div class="post-content docs">
          <p>If you haven’t read the Quickstart yet you should <a href="/getting-started/quickstart.html">start by reading that first</a>.</p>

<h3 id="using-existing-deployments">Using existing Deployments</h3>

<p>Let’s look in a bit more detail at using Telepresence when you have an existing <code class="highlighter-rouge">Deployment</code>.</p>

<p>Your Kubernetes configuration will typically have a <code class="highlighter-rouge">Service</code>:</p>

<p><code class="highlighter-rouge">yaml
apiVersion: v1
kind: Service
metadata:
  name: servicename-service
spec:
  ports:
    - port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    name: servicename
</code></p>

<p>You will also have a <code class="highlighter-rouge">Deployment</code> that actually runs your code, with labels that match the <code class="highlighter-rouge">Service</code> <code class="highlighter-rouge">selector</code>.
Let’s assume your existing deployment uses a database at <code class="highlighter-rouge">somewhere.someplace.cloud.example.com</code> port 5432, so you pass that information to the container as an environment variable:</p>

<p><code class="highlighter-rouge">yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: servicename-deployment
spec:
  replicas: 3
  template:
    metadata:
      labels:
        name: servicename
    spec:
      containers:
      - name: servicename
        image: examplecom/servicename:1.0.2
        ports:
        - containerPort: 8080
        env:
        - name: YOUR_DATABASE_HOST
          value: somewhere.someplace.cloud.example.com
</code></p>

<p>In order to run Telepresence you will need to do three things:</p>

<ol>
  <li>Replace your production <code class="highlighter-rouge">Deployment</code> with a custom <code class="highlighter-rouge">Deployment</code> that runs the Telepresence proxy.</li>
  <li>Run the Telepresence client locally.</li>
  <li>Run your own code inside the shell started the Telepresence client.</li>
</ol>

<p>Let’s go through these steps one by one.</p>

<p>First, instead of running the production <code class="highlighter-rouge">Deployment</code> above, you will need to run a different one that runs the Telepresence proxy instead.
It should only have 1 replica, and it will use a different image, but it should have the same environment variables since you want those available to your local code.</p>

<p><code class="highlighter-rouge">yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: servicename-deployment
spec:
  replicas: 1  # &lt;-- only one replica
  template:
    metadata:
      labels:
        name: servicename
    spec:
      containers:
      - name: servicename
        image: datawire/telepresence-k8s:0.40  # &lt;-- new image
        ports:
        - containerPort: 8080
        env:
        - name: YOUR_DATABASE_HOST
          value: somewhere.someplace.cloud.example.com
</code></p>

<p>You should apply this file to your cluster:</p>

<p><code class="highlighter-rouge">console
$ kubectl apply -f telepresence-deployment.yaml
</code></p>

<p>Next, you need to run the local Telepresence client on your machine.
You want to do the following:</p>

<ol>
  <li>Expose port 8080 in your code to Kubernetes.</li>
  <li>Connect specifically to the <code class="highlighter-rouge">servicename-deployment</code> pod you created above, in case there are multiple Telepresence users in the cluster.</li>
  <li>Run a local process in the above setup.</li>
</ol>

<p>Services <code class="highlighter-rouge">thing1</code> and <code class="highlighter-rouge">thing2</code> will be available to your code automatically so no special parameters are needed for them.
You can do so with the following command line, which uses <code class="highlighter-rouge">--deployment</code> instead of <code class="highlighter-rouge">--new-deployment</code> since there is an existing <code class="highlighter-rouge">Deployment</code> object:</p>

<p><code class="highlighter-rouge">console
$ telepresence --deployment servicename-deployment \
               --expose 8080 \
               --run-shell
@yourcluster|$ python servicename.py --port=8080 
</code></p>

<blockquote>
  <p><strong>Having trouble?</strong> Ask us a question in our <a href="https://gitter.im/datawire/telepresence">Gitter chatroom</a>.</p>
</blockquote>

<p>You are now running your own code locally, attaching it to the network stack of the Telepresence client and using the environment variables Telepresence client extracted.
Your code is connected to the remote Kubernetes cluster.</p>

<h3 id="environment-variables">Environment variables</h3>

<p>Environment variables set in the <code class="highlighter-rouge">Deployment</code> pod template (as in the example above) will be available to your local process.</p>

<h3 id="volumes">Volumes</h3>

<p>Volumes configured in the <code class="highlighter-rouge">Deployment</code> pod template will also be made your local process.
This is mostly intended for read-only volumes like <code class="highlighter-rouge">Secret</code> and <code class="highlighter-rouge">ConfigMap</code>, you probably don’t want a local database writing to a remote volume.</p>

<p>Volume support requires a small amount of work on your part.
The root directory where all the volumes can be found will be set to the <code class="highlighter-rouge">TELEPRESENCE_ROOT</code> environment variable in the shell run by <code class="highlighter-rouge">telepresence</code>.
You will then need to use that env variable as the root for volume paths you are opening.</p>

<p>For example, all Kubernetes containers have a volume mounted at <code class="highlighter-rouge">/var/run/secrets</code> with the service account details.
Those files are accessible from Telepresence:</p>

<p><code class="highlighter-rouge">console
$ cli/telepresence --new-deployment myservice --run-shell
Starting proxy...
@minikube|$ echo $TELEPRESENCE_ROOT
/tmp/tmpk_svwt_5
@minikube|$ ls $TELEPRESENCE_ROOT/var/run/secrets/kubernetes.io/serviceaccount/
ca.crt  namespace  token
</code></p>

<p>Of course, the files are available at a different path than they are on the actual production Kubernetes environment.</p>

<p>One way to deal with that is to modify your application’s code slightly.
For example, let’s say you have a volume that mounts a file called <code class="highlighter-rouge">/app/secrets</code>.
Normally you would just open it in your code like so:</p>

<p><code class="highlighter-rouge">python
secret_file = open("/app/secrets")
</code></p>

<p>In order to support volume proxying by Telepresence, you will need to change
your code (note that this is not the most succinct way to express this, it’s more verbose in order to be clear to non-Python programmers):</p>

<p><code class="highlighter-rouge">python
volume_root = "/"
if "TELEPRESENCE_ROOT" in os.environ:
    volume_root = os.environ["TELEPRESENCE_ROOT"]
secret_file = open(os.path.join(volume_root, "app/secrets"))
</code></p>

<p>By falling back to <code class="highlighter-rouge">/</code> when the environment variable is not set your code will continue to work in its normal Kubernetes setting.</p>

<p>Another way you can do this is by using the <a href="http://proot-me.github.io/">proot</a> utility on Linux, which allows you to do fake bind mounts without being root.
For example, presuming you’ve installed <code class="highlighter-rouge">proot</code> (<code class="highlighter-rouge">apt install proot</code> on Ubuntu), in the following example we bind <code class="highlighter-rouge">$TELEPRESENCE_ROOT/var/run/secrets</code> to <code class="highlighter-rouge">/var/run/secrets</code>.
That means code doesn’t need to be modified as the paths are in the expected location:</p>

<p><code class="highlighter-rouge">console
@minikube|$ proot -b $TELEPRESENCE_ROOT/var/run/secrets/:/var/run/secrets bash
$ ls /var/run/secrets/kubernetes.io/serviceaccount/
ca.crt  namespace  token
</code></p>

<h3 id="kubectl-context">kubectl context</h3>

<p>By default Telepresence uses whatever the current context is for <code class="highlighter-rouge">kubectl</code>.
If you want to choose a specific context you can use the <code class="highlighter-rouge">--context</code> option to <code class="highlighter-rouge">telepresence</code>.
For example:</p>

<p><code class="highlighter-rouge">console
$ telepresence --context minikube --new-deployment myservice --run-shell
</code></p>

<p>You can choose any context listed in <code class="highlighter-rouge">kubectl config get-contexts</code>.</p>

<p>If you’ve <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/#setting-the-namespace-preference">set a namespace for the context</a> then that namespace will be used to find/create the <code class="highlighter-rouge">Deployment</code>, but you can also choose a namespace explicitly, as shown in the next section.</p>

<h3 id="kubernetes-namespaces">Kubernetes namespaces</h3>

<p>If you want to proxy to a Deployment in a non-default namespace you can pass the <code class="highlighter-rouge">--namespace</code> argument to Telepresence:</p>

<p><code class="highlighter-rouge">console
$ telepresence --namespace yournamespace --deployment yourservice --run-shell
</code></p>

<h3 id="accessing-the-pod-from-your-process">Accessing the pod from your process</h3>

<p>In general Telepresence proxies all IPs and DNS lookups via the remote proxy pod.
There is one exception, however.</p>

<p><code class="highlighter-rouge">localhost</code> and <code class="highlighter-rouge">127.0.0.1</code> will end up accessing the host machine, the machine where you run <code class="highlighter-rouge">telepresence</code>, <em>not</em> the pod as is usually the case.
This mostly is a problem in cases where you are running multiple containers in a pod and you need your process to access a different container in the same pod.</p>

<p>The solution is to access the pod via its IP, rather than at <code class="highlighter-rouge">127.0.0.1</code>.
You can have the pod IP configured as an environment variable <code class="highlighter-rouge">$MY_POD_IP</code> in the Deployment using the Kubernetes <a href="https://kubernetes.io/docs/tasks/configure-pod-container/environment-variable-expose-pod-information/">Downward API</a>:</p>

<p><code class="highlighter-rouge">yaml
apiVersion: extensions/v1beta1
kind: Deployment
spec:
  template:
    spec:
      containers:
      - name: servicename
        image: datawire/telepresence-k8s:0.40
        env:
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
</code></p>


          <div><strong>Still have questions? Ask in our <a href="https://gitter.im/datawire/telepresence">Gitter chatroom</a> or <a href="https://github.com/datawire/telepresence/issues/new">file an issue on GitHub</a>.</strong></div>
        </div>
    </div>

    <div id="contents" class="two columns">
        <div data-kui-sticky></div>
    </div>
</div>

          </div>
      </div>

      <div class="grid">
  <div class="row">
    <footer class="basic menu top border">
      <div class="fluid">
        <span class="right header item">Copyright &copy; 2017 <a href="https://datawire.io">Datawire.io</a></span>
      </div>
    </footer>
  </div>
</div>
<script src="/js/sticky.min.js"></script>


      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85887707-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
